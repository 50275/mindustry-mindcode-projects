setrate(2147483647); 
BASEX = cell1.@x; 
BASEY = cell1.@y; 
CELLSX = @thisx - BASEX + 1; // this is intentional
CELLSY = @thisy - BASEY + 1; 
CELLS = CELLSX * CELLSY - 1; // exactly one space is used by the worldproc
def mwrite(i, new)
    cellN = i \ 512; 
    if cellN > CELLS then
        effect(cross, @thisx, @thisy); 
    end; 
    cellX = cellN % CELLSX + BASEX;
    cellY = cellN \ CELLSX + BASEY; 
    //println(cellX, " ", cellY); 
    //printflush(message1); 

    memory = getblock(building, cellX, cellY); 
    memory[i % 512] = new; 
end; 
def mread(i)
    cellN = i \ 512; 
    if cellN > CELLS then
        effect(cross, @thisx, @thisy); 
    end; 
    cellX = cellN % CELLSX + BASEX;
    cellY = cellN \ CELLSX + BASEY; 
    //println(cellX, " ", cellY); 
    //printflush(message1); 

    memory = getblock(building, cellX, cellY); 
    return memory[i % 512]; 
end; 

// NOT FOR USE IN MULTIPLAYER
r = 11; 
d = 9; 
frequency = 1; // trigger FREQUENCY times per second. with PERIOD = 1000/frequency (in milliseconds) 
period = 1000/frequency;  
G = @time; 
for i in 0...fetch(buildCount, @sharded, @duo) do
    building = fetch(build, @sharded, i, @duo); 
    shooting = building.@shooting; 
    if shooting == false then
        continue; 
    end; 
    lastshot = mread(i); 
    if lastshot + period < @time then
        // shoot
        //cell1[i] = @time; 
        mwrite(i, @time); 
    else 
        continue; 
    end; 
    println("You are firing the ", i, "th duo."); 
    printflush(message1); 
    ammo = building.sensor(@currentAmmoType); 
    if ammo == @copper then 
        d = 9; 
    elsif ammo == @graphite then
        d = 18; 
    elsif ammo == @silicon then
        d = 12;
    else
        d = 0; 
    end; 
    d *= 10; 
    X = building.@shootX; 
    Y = building.@shootY; 
    explosion(@sharded, X, Y, r, d, true, true, false); 
    effect(warn, X, Y);
end; 